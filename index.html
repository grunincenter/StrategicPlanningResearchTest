<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Grunin Center Research Data Viewer</title>
    
    <!-- Load Tailwind CSS for modern styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Load Brand Fonts: Montserrat (Sans for headers) and Frank Ruhl Libre (Serif for body) -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Frank+Ruhl+Libre:wght@300;400;500;700&family=Montserrat:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    
    <script>
        // --- Tailwind Configuration ---
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Montserrat', 'sans-serif'], // Headers/UI
                        serif: ['"Frank Ruhl Libre"', 'serif'], // Body Text
                    },
                    colors: {
                        grunin: {
                            blue: '#00abce',
                            green: '#73a535',
                            brown: '#925333',
                            deep_violet: '#330662',
                        },
                        nyu: {
                            violet: '#57068c', // Primary Header/Accent
                            light_gray: '#f2f2f2',
                        }
                    }
                }
            }
        }
    </script>
    <style>
        /* Custom styles for tab transitions and modal */
        body {
            background-color: #f2f2f2; 
        }
        .dashboard-container {
            border-top: 8px solid #57068c; 
            min-height: 90vh;
        }
        .tab-button.active {
            border-bottom: 4px solid #00abce;
            font-weight: 700;
            color: #57068c;
        }
        .data-table-row {
            transition: background-color 0.15s ease;
        }
        .modal {
            transition: opacity 0.3s ease;
        }
        .modal.hidden {
            opacity: 0;
            pointer-events: none;
        }
    </style>
</head>
<body class="font-serif">

    <div class="max-w-7xl mx-auto p-4 md:p-8 dashboard-container bg-white shadow-xl rounded-b-lg">
        
        <!-- Header & Branding -->
        <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-10 pb-4 border-b border-grunin-blue">
            <div class="mb-4 md:mb-0">
                <h1 class="text-3xl font-sans font-bold leading-tight text-nyu-violet">
                    Competitive Research Data Explorer
                </h1>
                <h2 id="current-tab-subtitle" class="text-lg font-sans font-medium text-grunin-blue tracking-wider">
                    Short List of Competitive Institutions
                </h2>
            </div>
            <div class="text-right text-sm font-sans">
                <p class="font-bold uppercase tracking-widest text-grunin-deep_violet">Grunin Center for Law and Social Entrepreneurship</p>
                <p class="text-gray-500">NYU School of Law</p>
            </div>
        </div>

        <!-- Tabs -->
        <div class="flex border-b border-gray-300 mb-6">
            <button id="tab-shortlist" onclick="changeTab('shortList')" class="tab-button active px-4 py-3 text-lg font-sans font-medium text-nyu-violet transition duration-150 hover:bg-nyu-light_gray">
                Short List
            </button>
            <button id="tab-institutes" onclick="changeTab('institutes')" class="tab-button px-4 py-3 text-lg font-sans font-medium text-gray-500 transition duration-150 hover:bg-nyu-light_gray">
                Institutes, Centers, & Programs
            </button>
        </div>

        <!-- Search Control -->
        <input type="text" id="search-input" placeholder="Search the data..." 
               class="w-full p-3 mb-6 border-2 border-nyu-violet rounded-lg font-serif shadow-inner focus:ring-2 focus:ring-grunin-blue focus:border-grunin-blue transition duration-150"
               onkeyup="renderTable()">
        
        <!-- Loading State -->
        <div id="loading-state" class="text-center py-20">
            <svg class="animate-spin mx-auto h-10 w-10 text-grunin-blue" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
            <p class="mt-4 text-gray-600 font-sans font-medium">Loading data from uploaded files...</p>
        </div>

        <!-- Data Table Container -->
        <div id="table-container" class="overflow-x-auto shadow-xl rounded-lg border border-gray-200 hidden">
            <table class="min-w-full divide-y divide-gray-200">
                <thead class="bg-grunin-deep_violet text-white">
                    <tr id="table-header-row">
                        <!-- Headers injected here -->
                    </tr>
                </thead>
                <tbody id="data-table-body" class="bg-white divide-y divide-gray-100">
                    <!-- Data rows will be injected here -->
                </tbody>
            </table>
        </div>

        <div id="no-results" class="text-center py-12 text-xl font-serif text-gray-500 hidden">
            No results found for the current search.
        </div>
    </div>

    <!-- Detail Modal (Short List Drill Down) -->
    <div id="detail-modal" class="modal hidden fixed inset-0 z-50 flex items-center justify-center p-4 bg-black bg-opacity-70" onclick="hideModal()">
        <div class="bg-white rounded-lg shadow-2xl w-full max-w-4xl max-h-[90vh] overflow-y-auto" onclick="event.stopPropagation()">
            <div class="p-6 md:p-8">
                <div class="flex justify-between items-start pb-4 border-b border-gray-200">
                    <h3 id="modal-institution-name" class="text-2xl font-sans font-bold text-nyu-violet">Institution Name</h3>
                    <button onclick="hideModal()" class="text-gray-500 hover:text-gray-700 text-3xl leading-none font-light">&times;</button>
                </div>

                <div class="mt-4">
                    <h4 class="text-lg font-sans font-semibold mb-3 text-grunin-deep_violet border-b border-grunin-blue/50 pb-1">Full Short List Assessment</h4>
                    <div id="modal-shortlist-detail" class="text-gray-700 space-y-3 font-serif mb-6"></div>
                    
                    <h4 class="text-lg font-sans font-semibold mb-3 text-grunin-deep_violet border-b border-grunin-blue/50 pb-1">Related Institutes, Centers, & Programs</h4>
                    <div id="modal-centers-detail" class="space-y-4">
                        <p class="text-gray-500 italic">Loading related center data...</p>
                    </div>
                </div>
            </div>
            <div class="p-4 bg-nyu-light_gray text-right rounded-b-lg">
                <button onclick="hideModal()" class="px-4 py-2 bg-nyu-violet text-white font-sans font-medium rounded-lg hover:bg-nyu-violet/80 transition duration-150">Close</button>
            </div>
        </div>
    </div>

    <script>
        // =================================================================================
        // *** Data Access is now using your uploaded CSV files directly by name ***
        // =================================================================================
        
        // The file paths now point directly to the files you uploaded.
        // We are using the file names from the conversation history to ensure the correct files are accessed.
        const FILE_PATHS = {
            shortList: 'uploaded:Short List CSV - Short List.csv', 
            institutes: 'uploaded:Institutes, Centers, & Programs CSV - Institutes, Centers, & Programs.csv' 
        };

        const MAX_RETRIES = 3;
        const SHORT_LIST_COLUMNS_TO_DISPLAY = [
            'Institution', 
            'Institution Descriptions', 
            'Centers and Clinics', 
            'Relevant Centers, Institutes, & Programs', 
            'Recurring symposia',
            'Relevant clinic clients'
        ];
        const INSTITUTES_COLUMNS_TO_DISPLAY = [
            'Institution', 
            'Center Name', 
            'Notes from Grunin Team', 
            'Appeared in 2017 Research'
        ];

        // --- Global State ---
        let allData = { shortList: [], institutes: [] };
        let currentTab = 'shortList';
        let currentSortColumn = null;
        let currentSortDirection = 'asc';
        
        // --- Core Data Handling Functions ---

        /**
         * Simple CSV parser that handles header row and quote-encapsulated values.
         * @param {string} csv The raw CSV text.
         * @returns {Array<Object>} Array of objects representing the CSV rows.
         */
        function parseCSV(csv) {
            const lines = csv.split(/\r\n|\n/);
            if (lines.length < 1) return [];

            // Simple handling for the header row which contains messy commas
            const rawHeaders = lines[0].split(',');
            const headers = rawHeaders.map(h => h.trim().replace(/['"]+/g, '').replace(/[^a-zA-Z0-9_\s,]/g, '').trim());

            const data = [];
            for (let i = 1; i < lines.length; i++) {
                const line = lines[i];
                if (!line.trim()) continue;

                // Simple regex split for values, respecting quoted strings
                const values = line.match(/(?:\"([^\"]*(?:\"\"[^\"]*)*)\")|([^\,]+)/g);
                if (!values) continue;
                
                const row = {};
                for (let j = 0; j < headers.length && j < values.length; j++) {
                    let val = values[j];
                    if (val) {
                         val = val.trim();
                         // Clean up quotes and handle the empty trailing columns common in the short list file
                         if (val.startsWith('"') && val.endsWith('"')) {
                            val = val.substring(1, val.length - 1).replace(/""/g, '"');
                         }
                    } else {
                        val = '';
                    }

                    if (headers[j]) {
                         const key = headers[j];
                         row[key] = val;
                    }
                }
                data.push(row);
            }
            return data;
        }

        /**
         * Fetches and parses a single CSV file with retries.
         * @param {string} filePath The path to the CSV file (now the 'uploaded:filename' path).
         * @returns {Promise<Array<Object>>} Parsed data.
         */
        async function fetchFile(filePath) {
            for (let i = 0; i < MAX_RETRIES; i++) {
                try {
                    console.log(`Fetching: ${filePath}`);
                    // Fetch is automatically handled by the environment for 'uploaded:' paths
                    const response = await fetch(filePath);
                    if (!response.ok) throw new Error(`HTTP error! status: ${response.status} for ${filePath}`);
                    const text = await response.text();
                    return parseCSV(text);
                } catch (error) {
                    console.error(`Attempt ${i + 1} failed for ${filePath}:`, error);
                    if (i === MAX_RETRIES - 1) throw new Error(`Failed to load data for ${filePath} after ${MAX_RETRIES} attempts. Check file names in FILE_PATHS.`);
                    await new Promise(resolve => setTimeout(resolve, 1000 * Math.pow(2, i))); // Exponential backoff (1s, 2s, 4s)
                }
            }
        }

        /**
         * Loads all data files.
         */
        async function loadAllData() {
            try {
                // Wait for both files to load concurrently
                const [shortList, institutes] = await Promise.all([
                    fetchFile(FILE_PATHS.shortList),
                    fetchFile(FILE_PATHS.institutes)
                ]);
                
                // Filter out empty rows based on Institution name
                allData.shortList = shortList.filter(row => row.Institution); 
                allData.institutes = institutes.filter(row => row.Institution);
                
                // Show content and hide loading
                document.getElementById('loading-state').classList.add('hidden');
                document.getElementById('table-container').classList.remove('hidden');

                // Initial render
                renderTable();

            } catch (error) {
                console.error('Fatal data loading error:', error);
                document.getElementById('loading-state').innerHTML = `<p class="mt-4 text-red-600 font-sans font-medium">
                    Error loading data. Check console for details. **Did you upload the correct files?**
                </p><p class="mt-2 text-sm text-red-400">Error: ${error.message}</p>`;
            }
        }

        // --- UI Logic Functions ---

        /**
         * Changes the active tab and re-renders the table.
         * @param {string} tabName 'shortList' or 'institutes'.
         */
        window.changeTab = function(tabName) {
            currentTab = tabName;
            
            // Update button visual state
            document.querySelectorAll('.tab-button').forEach(btn => {
                btn.classList.remove('active');
                btn.classList.remove('text-gray-500');
                if (btn.id === `tab-${tabName}`) {
                    btn.classList.add('active');
                    btn.classList.remove('text-gray-500');
                } else {
                    btn.classList.add('text-gray-500');
                }
            });
            
            // Update subtitle
            const subtitle = tabName === 'shortList' ? 'Short List of Competitive Institutions' : 'Institutes, Centers, & Programs Details';
            document.getElementById('current-tab-subtitle').textContent = subtitle;

            // Reset search input and sorting
            document.getElementById('search-input').value = '';
            currentSortColumn = null;
            currentSortDirection = 'asc';

            renderTable();
        }

        /**
         * Handles table sorting logic.
         * @param {string} column 
         */
        window.sortTable = function(column) {
            if (currentSortColumn === column) {
                currentSortDirection = currentSortDirection === 'asc' ? 'desc' : 'asc';
            } else {
                currentSortColumn = column;
                currentSortDirection = 'asc'; // Default sort to ascending for new column
            }
            renderTable();
        }

        /**
         * Renders the data table based on current state (tab, search, sort).
         */
        window.renderTable = function() {
            const data = allData[currentTab];
            const columns = currentTab === 'shortList' ? SHORT_LIST_COLUMNS_TO_DISPLAY : INSTITUTES_COLUMNS_TO_DISPLAY;
            const tableBody = document.getElementById('data-table-body');
            const tableHeaderRow = document.getElementById('table-header-row');
            const searchInput = document.getElementById('search-input').value.toLowerCase();
            const noResults = document.getElementById('no-results');

            // 1. Filter Data
            let filteredData = data.filter(item => {
                const searchMatch = searchInput === '' || 
                    Object.values(item).some(value => 
                        String(value).toLowerCase().includes(searchInput)
                    );
                return searchMatch;
            });

            // 2. Sort Data
            if (currentSortColumn) {
                filteredData.sort((a, b) => {
                    const aVal = String(a[currentSortColumn] || '').toLowerCase();
                    const bVal = String(b[currentSortColumn] || '').toLowerCase();
                    let comparison = 0;

                    if (aVal > bVal) comparison = 1;
                    else if (aVal < bVal) comparison = -1;

                    return currentSortDirection === 'asc' ? comparison : comparison * -1;
                });
            }

            // 3. Render Headers
            tableHeaderRow.innerHTML = columns.map(col => {
                const isCurrentSort = col === currentSortColumn;
                const sortIndicator = isCurrentSort ? (currentSortDirection === 'asc' ? ' ▲' : ' ▼') : '';
                
                return `
                    <th onclick="sortTable('${col}')" class="cursor-pointer px-6 py-3 text-left text-xs font-sans font-bold uppercase tracking-wider hover:bg-nyu-violet transition duration-150 whitespace-nowrap">
                        ${col.replace(/_/g, ' ')} <span class="text-gray-400">${sortIndicator}</span>
                    </th>
                `;
            }).join('');
            
            // 4. Render Rows
            tableBody.innerHTML = '';
            if (filteredData.length === 0) {
                noResults.classList.remove('hidden');
            } else {
                noResults.classList.add('hidden');
            }

            filteredData.forEach(item => {
                const isShortList = currentTab === 'shortList';
                const rowClass = isShortList ? 'cursor-pointer data-table-row hover:bg-nyu-light_gray' : 'data-table-row';
                // Need to escape single quotes in the institution name for the JS function call
                const clickHandler = isShortList ? `onclick="showDetails('${item.Institution.replace(/'/g, "\\'")}')"` : '';
                
                const cells = columns.map(col => {
                    let content = item[col] || '';
                    if (isShortList && col === 'Institution') {
                         // Make the Institution link clearly look like a drill-down target
                         content = `<span class="font-bold text-grunin-deep_violet">${content}</span><span class="text-grunin-blue ml-2 font-sans font-medium text-xs">&rarr; View Details</span>`;
                    } else if (col === 'Appeared in 2017 Research') {
                        // Check for various casing of TRUE/FALSE
                        const status = String(content).trim().toUpperCase();
                        const statusText = status === 'TRUE' ? 'YES' : 'NO';
                        const statusClass = status === 'TRUE' ? 'bg-grunin-green text-white' : 'bg-grunin-brown/50 text-white';
                        content = `<span class="inline-block px-3 py-1 text-xs font-sans font-bold rounded-full ${statusClass}">${statusText}</span>`;
                    }
                    return `<td class="px-6 py-4 text-sm font-serif text-gray-700 align-top leading-relaxed">${content}</td>`;
                }).join('');

                const row = `<tr class="${rowClass}" ${clickHandler}>${cells}</tr>`;
                tableBody.insertAdjacentHTML('beforeend', row);
            });
        }

        /**
         * Shows the detail modal for a Short List institution.
         * @param {string} institutionName 
         */
        window.showDetails = function(institutionName) {
            const primaryItem = allData.shortList.find(item => item.Institution === institutionName);
            const secondaryItems = allData.institutes.filter(item => item.Institution === institutionName);

            document.getElementById('modal-institution-name').textContent = institutionName;
            
            // --- 1. Populate Short List Detail ---
            const shortListDetailEl = document.getElementById('modal-shortlist-detail');
            shortListDetailEl.innerHTML = '';

            if (primaryItem) {
                // Loop through all relevant Short List columns for a detailed view
                SHORT_LIST_COLUMNS_TO_DISPLAY.forEach(key => {
                    if (key !== 'Institution') {
                        const value = primaryItem[key] || 'N/A';
                        shortListDetailEl.insertAdjacentHTML('beforeend', `
                            <div class="p-2 border-b border-gray-100">
                                <p class="font-sans font-semibold text-grunin-deep_violet text-sm uppercase">${key.replace(/_/g, ' ')}</p>
                                <p class="text-gray-700 whitespace-pre-wrap">${value}</p>
                            </div>
                        `);
                    }
                });
            }

            // --- 2. Populate Institutes & Centers Detail ---
            const centersDetailEl = document.getElementById('modal-centers-detail');
            centersDetailEl.innerHTML = '';

            if (secondaryItems.length > 0) {
                secondaryItems.forEach(detail => {
                    const appeared = detail['Appeared in 2017 Research'];
                    const status = String(appeared).trim().toUpperCase();
                    const appearedClass = status === 'TRUE' ? 'text-grunin-green font-bold' : 'text-grunin-brown/80 font-medium';
                    const detailHtml = `
                        <div class="border-b last:border-b-0 pb-3">
                            <p class="font-sans font-semibold text-gray-800">${detail['Center Name'] || 'Center Name N/A'}</p>
                            <p class="text-xs font-serif italic text-gray-600">${detail['Notes from Grunin Team'] || 'No notes available.'}</p>
                            <p class="text-xs font-sans mt-1 ${appearedClass}">
                                Research Status: ${status === 'TRUE' ? 'Mentioned in 2017 Research' : 'New/Updated Since 2017'}
                            </p>
                        </div>
                    `;
                    centersDetailEl.insertAdjacentHTML('beforeend', detailHtml);
                });
            } else {
                centersDetailEl.innerHTML = '<p class="text-gray-500 italic">No specific Institutes, Centers, or Programs found in the secondary dataset for this institution.</p>';
            }

            document.getElementById('detail-modal').classList.remove('hidden');
        }

        /**
         * Hides the detail modal.
         */
        window.hideModal = function() {
            document.getElementById('detail-modal').classList.add('hidden');
        }

        // --- Initialization ---

        document.addEventListener('DOMContentLoaded', () => {
            loadAllData();
        });
        
    </script>
</body>
</html>
